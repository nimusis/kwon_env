#!/bin/bash

KWON_CONFIG_HOME=$HOME/".kwon_env"
ZSHRC_PATH=$HOME/.zshrc

function set_config() {
  sed -i "s/^\($1\s*=\s*\).*\$/\1$2/" $ZSHRC_PATH
}

function remove_comments() {
	sed -i "s/#.*$1/$1/;/^$/d" $ZSHRC_PATH
}

function uninstall() {
	rm -rf $KWON_CONFIG_HOME
	rm $ZSHRC_PATH
	rm ~/.oh-my-zsh
}

################## 필요 파일 설치 ##################
mkdir -p $KWON_CONFIG_HOME
# oh-my-zsh 설치
ZSH="$KWON_CONFIG_HOME/oh-my-zsh" sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)" "" --skip-chsh --unattended --keep-zshrc

# oh-my-zsh 플러그인 설치
git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-syntax-highlighting

# fzf 설치
git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf && ~/.fzf/install --bin --all --no-bash --no-fish

# oh-my-tmux 설치
curl -fLo $KWON_CONFIG_HOME/tmux/tmux.conf --create-dirs https://raw.githubusercontent.com/gpakosz/.tmux/master/.tmux.conf
curl -fLo $KWON_CONFIG_HOME/tmux/tmux.conf.local --create-dirs https://raw.githubusercontent.com/gpakosz/.tmux/master/.tmux.conf.local

# 정근님 vim 플러그인 설치
curl -fLo $KWON_CONFIG_HOME/vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim


################## 내 설정파일 다운로드 ##################
curl -fLo $KWON_CONFIG_HOME/vimrc --create-dirs https://raw.githubusercontent.com/nimusis/kwon_env/master/vimrc
curl -fLo $KWON_CONFIG_HOME/zshrc --create-dirs https://raw.githubusercontent.com/nimusis/kwon_env/master/zshrc


################## zsh 설정 변경 ##################
remove_comments HIST_STAMPS

set_config ZSH_THEME \"agnoster\"
set_config HIST_STAMPS \"yyyy-mm-dd\"
set_config plugins "(git zsh-autosuggestions zsh-syntax-highlighting)"

# zsh 마지막 라인에 추가
if grep -q '.kwon_env' $ZSHRC_PATH; then
	echo "kwon_env aliases already exist!"
else
	cat <<EOT >> $ZSHRC_PATH

prompt_context() {
  if [[ "\$USER" != "\$DEFAULT_USER" || -n "\$SSH_CLIENT" ]]; then
    prompt_segment black default "%(!.%{%F{yellow}%}.)\$USER"
  fi  
}

export TERM=xterm-256color
export SHELL=/usr/bin/zsh
export XDG_CONFIG_HOME=$KWON_CONFIG_HOME

tmux source $KWON_CONFIG_HOME/tmux/tmux.conf

###############################
alias vi='vim -u $KWON_CONFIG_HOME/vimrc'
alias vim='vim -u $KWON_CONFIG_HOME/vimrc'

alias ta="tmux -2 attach -t "
alias tn="tmux -2 new -s "
alias tm="tmux -2 attach -t MAIN"
alias tl="tmux -2 ls"

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
EOT
fi

